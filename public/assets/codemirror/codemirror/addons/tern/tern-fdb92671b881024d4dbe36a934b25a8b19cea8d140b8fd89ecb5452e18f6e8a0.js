!function(e){"object"==typeof exports&&"object"==typeof module?e(require("../../lib/codemirror")):"function"==typeof define&&define.amd?define(["../../lib/codemirror"],e):e(CodeMirror)}(function(v){"use strict";function s(e,t,n){var o=e.docs[t];o?n(F(e,o)):e.options.getFile?e.options.getFile(t,n):n(null)}function u(e,t,n){for(var o in e.docs){var i=e.docs[o];if(i.doc==t)return i}if(!n)for(var r=0;;++r)if(o="[doc"+(r||"")+"]",!e.docs[o]){n=o;break}return e.addDoc(n,t)}function n(e,t){return"string"==typeof t?e.docs[t]:(t instanceof v&&(t=t.getDoc()),t instanceof v.Doc?u(e,t):void 0)}function o(e,t,n){var o=u(e,t),i=e.cachedArgHints;i&&i.doc==t&&0<=E(i.start,n.to)&&(e.cachedArgHints=null);var r=o.changed;null==r&&(o.changed=r={from:n.from.line,to:n.from.line});var s=n.from.line+(n.text.length-1);n.from.line<r.to&&(r.to=r.to-(n.to.line-s)),s>=r.to&&(r.to=s+1),r.from>n.from.line&&(r.from=n.from.line),t.lineCount()>O&&100<n.to-r.from&&setTimeout(function(){o.changed&&100<o.changed.to-o.changed.from&&a(e,o)},200)}function a(e,t){e.server.request({files:[{type:"full",name:t.name,text:F(e,t)}]},function(e){e?window.console.error(e):t.changed=null})}function i(f,d,p){f.request(d,{type:"completions",types:!0,docs:!0,urls:!0},function(e,t){if(e)return q(f,d,e);var n=[],o="",i=t.start,r=t.end;'["'==d.getRange(j(i.line,i.ch-2),i)&&'"]'!=d.getRange(r,j(r.line,r.ch+2))&&(o='"]');for(var s=0;s<t.completions.length;++s){var a=t.completions[s],c=h(a.type);t.guess&&(c+=" "+L+"guess"),n.push({text:a.name+o,displayText:a.displayName||a.name,className:c,data:a})}var l={from:i,to:r,list:n},u=null;v.on(l,"close",function(){H(u)}),v.on(l,"update",function(){H(u)}),v.on(l,"select",function(e,t){H(u);var n=f.options.completionTip?f.options.completionTip(e.data):e.data.doc;n&&((u=A(t.parentNode.getBoundingClientRect().right+window.pageXOffset,t.getBoundingClientRect().top+window.pageYOffset,n)).className+=" "+L+"hint-doc")}),p(l)})}function h(e){var t;return t="?"==e?"unknown":"number"==e||"string"==e||"bool"==e?e:/^fn\(/.test(e)?"fn":/^\[/.test(e)?"array":"object",L+"completion "+L+"completion-"+t}function r(i,r,e,t,s){i.request(r,t,function(e,t){if(e)return q(i,r,e);if(i.options.typeTip)var n=i.options.typeTip(t);else{n=w("span",null,w("strong",null,t.type||"not found"));if(t.doc&&n.appendChild(document.createTextNode(" \u2014 "+t.doc)),t.url){n.appendChild(document.createTextNode(" "));var o=n.appendChild(w("a",null,"[docs]"));o.href=t.url,o.target="_blank"}}k(r,n,i),s&&s()},e)}function t(n,o){if(S(n),!o.somethingSelected()){var e=o.getTokenAt(o.getCursor()).state,t=v.innerMode(o.getMode(),e);if("javascript"==t.mode.name){var i=t.state.lexical;if("call"==i.info){for(var r,s=i.pos||0,a=o.getOption("tabSize"),c=o.getCursor().line,l=Math.max(0,c-9),u=!1;l<=c;--c){for(var f=o.getLine(c),d=0,p=0;;){var h=f.indexOf("\t",p);if(-1==h)break;d+=a-(h+d)%a-1,p=h+1}if(r=i.column-d,"("==f.charAt(r)){u=!0;break}}if(u){var g=j(c,r),m=n.cachedArgHints;if(m&&m.doc==o.getDoc()&&0==E(g,m.start))return y(n,o,s);n.request(o,{type:"type",preferFunction:!0,end:g},function(e,t){!e&&t.type&&/^fn\(/.test(t.type)&&(n.cachedArgHints={start:g,type:C(t.type),name:t.exprName||t.name||"fn",guess:t.guess,doc:o.getDoc()},y(n,o,s))})}}}}}function y(e,t,n){S(e);for(var o=e.cachedArgHints,i=o.type,r=w("span",o.guess?L+"fhint-guess":null,w("span",L+"fname",o.name),"("),s=0;s<i.args.length;++s){s&&r.appendChild(document.createTextNode(", "));var a=i.args[s];r.appendChild(w("span",L+"farg"+(s==n?" "+L+"farg-current":""),a.name||"?")),"?"!=a.type&&(r.appendChild(document.createTextNode(":\xa0")),r.appendChild(w("span",L+"type",a.type)))}r.appendChild(document.createTextNode(i.rettype?") ->\xa0":")")),i.rettype&&r.appendChild(w("span",L+"type",i.rettype));var c=t.cursorCoords(null,"page"),l=e.activeArgHints=A(c.right+1,c.bottom,r);setTimeout(function(){l.clear=D(t,function(){e.activeArgHints==l&&S(e)})},20)}function C(i){function e(e){for(var t=0,n=r;;){var o=i.charAt(r);if(e.test(o)&&!t)return i.slice(n,r);/[{\[\(]/.test(o)?++t:/[}\]\)]/.test(o)&&--t,++r}}var t=[],r=3;if(")"!=i.charAt(r))for(;;){var n=i.slice(r).match(/^([^, \(\[\{]+): /);if(n&&(r+=n[0].length,n=n[1]),t.push({name:n,type:e(/[\),]/)}),")"==i.charAt(r))break;r+=2}var o=i.slice(r).match(/^\) -> (.*)$/);return{args:t,rettype:o&&o[1]}}function c(r,s){function t(e){var t={type:"definition",variable:e||null},i=u(r,s.getDoc());r.server.request(x(r,i,t),function(e,t){if(e)return q(r,s,e);if(t.file||!t.url){if(t.file){var n,o=r.docs[t.file];if(o&&(n=d(o.doc,t)))return r.jumpStack.push({file:i.name,start:s.getCursor("from"),end:s.getCursor("to")}),void f(r,i,o,n.start,n.end)}q(r,s,"Could not find a definition.")}else window.open(t.url)})}e(s)?t():T(s,"Jump to variable",function(e){e&&t(e)})}function l(e,t){var n=e.jumpStack.pop(),o=n&&e.docs[n.file];o&&f(e,u(e,t.getDoc()),o,n.start,n.end)}function f(e,t,n,o,i){n.doc.setSelection(o,i),t!=n&&e.options.switchToDoc&&(S(e),e.options.switchToDoc(n.name,n.doc))}function d(e,t){for(var n=t.context.slice(0,t.contextOffset).split("\n"),o=t.start.line-(n.length-1),i=j(o,(1==n.length?t.start.ch:e.getLine(o).length)-n[0].length),r=e.getLine(o).slice(i.ch),s=o+1;s<e.lineCount()&&r.length<t.context.length;++s)r+="\n"+e.getLine(s);if(r.slice(0,t.context.length)==t.context)return t;for(var a,c=e.getSearchCursor(t.context,0,!1),l=Infinity;c.findNext();){var u=c.from(),f=1e4*Math.abs(u.line-i.line);f||(f=Math.abs(u.ch-i.ch)),f<l&&(a=u,l=f)}if(!a)return null;if(1==n.length?a.ch+=n[0].length:a=j(a.line+(n.length-1),n[n.length-1].length),t.start.line==t.end.line)var d=j(a.line,a.ch+(t.end.ch-t.start.ch));else d=j(a.line+(t.end.line-t.start.line),t.end.ch);return{start:a,end:d}}function e(e){var t=e.getCursor("end"),n=e.getTokenAt(t);return!(n.start<t.ch&&"comment"==n.type)&&/[\w)\]]/.test(e.getLine(t.line).slice(Math.max(t.ch-1,0),t.ch+1))}function p(n,o){var e=o.getTokenAt(o.getCursor());if(!/\w/.test(e.string))return q(n,o,"Not at a variable");T(o,"New name for "+e.string,function(e){n.request(o,{type:"rename",newName:e,fullDocs:!0},function(e,t){if(e)return q(n,o,e);m(n,t.changes)})})}function g(a,c){var l=u(a,c.doc).name;a.request(c,{type:"refs"},function(e,t){if(e)return q(a,c,e);for(var n=[],o=0,i=c.getCursor(),r=0;r<t.refs.length;r++){var s=t.refs[r];s.file==l&&(n.push({anchor:s.start,head:s.end}),0<=E(i,s.start)&&E(i,s.end)<=0&&(o=n.length-1))}c.setSelections(n,o)})}function m(e,t){for(var n=Object.create(null),o=0;o<t.length;++o){(n[(c=t[o]).file]||(n[c.file]=[])).push(c)}for(var i in n){var r=e.docs[i],s=n[i];if(r){s.sort(function(e,t){return E(t.start,e.start)});var a="*rename"+ ++R;for(o=0;o<s.length;++o){var c=s[o];r.doc.replaceRange(c.text,c.start,c.end,a)}}}}function x(e,t,n,o){var i=[],r=0,s=!n.fullDocs;s||delete n.fullDocs,"string"==typeof n&&(n={type:n}),n.lineCharPositions=!0,null==n.end&&(n.end=o||t.doc.getCursor("end"),t.doc.somethingSelected()&&(n.start=t.doc.getCursor("start")));var a=n.start||n.end;if(t.changed)if(t.doc.lineCount()>O&&!1!==s&&t.changed.to-t.changed.from<100&&t.changed.from<=a.line&&t.changed.to>n.end.line){i.push(b(t,a,n.end)),n.file="#0";r=i[0].offsetLines;null!=n.start&&(n.start=j(n.start.line- -r,n.start.ch)),n.end=j(n.end.line-r,n.end.ch)}else i.push({type:"full",name:t.name,text:F(e,t)}),n.file=t.name,t.changed=null;else n.file=t.name;for(var c in e.docs){var l=e.docs[c];l.changed&&l!=t&&(i.push({type:"full",name:l.name,text:F(e,l)}),l.changed=null)}return{query:n,files:i}}function b(e,t,n){for(var o,i=e.doc,r=null,s=null,a=4,c=t.line-1,l=Math.max(0,c-50);l<=c;--c){var u=i.getLine(c);if(!(u.search(/\bfunction\b/)<0)){var f=v.countColumn(u,null,a);null!=r&&r<=f||(r=f,s=c)}}null==s&&(s=l);var d=Math.min(i.lastLine(),n.line+20);if(null==r||r==v.countColumn(i.getLine(t.line),null,a))o=d;else for(o=n.line+1;o<d;++o){if((f=v.countColumn(i.getLine(o),null,a))<=r)break}var p=j(s,0);return{type:"part",name:e.name,offsetLines:p.line,text:i.getRange(p,j(o,n.line==o?null:0))}}function w(e,t){var n=document.createElement(e);t&&(n.className=t);for(var o=2;o<arguments.length;++o){var i=arguments[o];"string"==typeof i&&(i=document.createTextNode(i)),n.appendChild(i)}return n}function T(e,t,n){e.openDialog?e.openDialog(t+": <input type=text>",n):n(prompt(t,""))}function k(e,t,n){function o(){c=!0,a||i()}function i(){e.state.ternTooltip=null,s.parentNode&&N(s),l()}e.state.ternTooltip&&H(e.state.ternTooltip);var r=e.cursorCoords(),s=e.state.ternTooltip=A(r.right+1,r.bottom,t),a=!1,c=!1;v.on(s,"mousemove",function(){a=!0}),v.on(s,"mouseout",function(e){var t=e.relatedTarget||e.toElement;t&&v.contains(s,t)||(c?i():a=!1)}),setTimeout(o,n.options.hintDelay?n.options.hintDelay:1700);var l=D(e,i)}function D(e,t){return e.on("cursorActivity",t),e.on("blur",t),e.on("scroll",t),e.on("setDoc",t),function(){e.off("cursorActivity",t),e.off("blur",t),e.off("scroll",t),e.off("setDoc",t)}}function A(e,t,n){var o=w("div",L+"tooltip",n);return o.style.left=e+"px",o.style.top=t+"px",document.body.appendChild(o),o}function H(e){var t=e&&e.parentNode;t&&t.removeChild(e)}function N(e){e.style.opacity="0",setTimeout(function(){H(e)},1100)}function q(e,t,n){e.options.showError?e.options.showError(t,n):k(t,String(n),e)}function S(e){e.activeArgHints&&(e.activeArgHints.clear&&e.activeArgHints.clear(),H(e.activeArgHints),e.activeArgHints=null)}function F(e,t){var n=t.doc.getValue();return e.options.fileFilter&&(n=e.options.fileFilter(n,t.name,t.doc)),n}function M(t){function o(e,t){t&&(e.id=++i,r[i]=t),n.postMessage(e)}var n=t.worker=new Worker(t.options.workerScript);n.postMessage({type:"init",defs:t.options.defs,plugins:t.options.plugins,scripts:t.options.workerDeps});var i=0,r={};n.onmessage=function(e){var n=e.data;"getFile"==n.type?s(t,n.name,function(e,t){o({type:"getFile",err:String(e),text:t,id:n.id})}):"debug"==n.type?window.console.log(n.message):n.id&&r[n.id]&&(r[n.id](n.err,n.body),delete r[n.id])},n.onerror=function(e){for(var t in r)r[t](e);r={}},this.addFile=function(e,t){o({type:"add",name:e,text:t})},this.delFile=function(e){o({type:"del",name:e})},this.request=function(e,t){o({type:"req",body:e},t)}}v.TernServer=function(e){var n=this;this.options=e||{};var t=this.options.plugins||(this.options.plugins={});t.doc_comment||(t.doc_comment=!0),this.docs=Object.create(null),this.options.useWorker?this.server=new M(this):this.server=new tern.Server({getFile:function(e,t){return s(n,e,t)},async:!0,defs:this.options.defs||[],plugins:t}),this.trackChange=function(e,t){o(n,e,t)},this.cachedArgHints=null,this.activeArgHints=null,this.jumpStack=[],this.getHint=function(e,t){return i(n,e,t)},this.getHint.async=!0},v.TernServer.prototype={addDoc:function(e,t){var n={doc:t,name:e,changed:null};return this.server.addFile(e,F(this,n)),v.on(t,"change",this.trackChange),this.docs[e]=n},delDoc:function(e){var t=n(this,e);t&&(v.off(t.doc,"change",this.trackChange),delete this.docs[t.name],this.server.delFile(t.name))},hideDoc:function(e){S(this);var t=n(this,e);t&&t.changed&&a(this,t)},complete:function(e){e.showHint({hint:this.getHint})},showType:function(e,t,n){r(this,e,t,"type",n)},showDocs:function(e,t,n){r(this,e,t,"documentation",n)},updateArgHints:function(e){t(this,e)},jumpToDef:function(e){c(this,e)},jumpBack:function(e){l(this,e)},rename:function(e){p(this,e)},selectName:function(e){g(this,e)},request:function(e,n,o,t){var i=this,r=u(this,e.getDoc()),s=x(this,r,n,t),a=s.query&&this.options.queryOptions&&this.options.queryOptions[s.query.type];if(a)for(var c in a)s.query[c]=a[c];this.server.request(s,function(e,t){!e&&i.options.responseFilter&&(t=i.options.responseFilter(r,n,s,e,t)),o(e,t)})},destroy:function(){S(this),this.worker&&(this.worker.terminate(),this.worker=null)}};var j=v.Pos,L="CodeMirror-Tern-",O=250,R=0,E=v.cmpPos});